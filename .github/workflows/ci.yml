name: CI
# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
jobs:
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest 
    services:
      db:
        image: mysql:5.7
        env:
          MYSQL_USERNAME: root
          MYSQL_ROOT_PASSWORD: password
#           MYSQL_PASSWORD: password
#           MYSQL_ROOT_PASSWORD: password
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3306
          MYSQL_DATABASE: test
        ports:
          - 8888:3306
#         options: >-
#           --health-cmd="mysqladmin ping"
#           --health-interval=10s
#           --health-timeout=5s
#           --health-retries=5
  
    steps:
      - uses: actions/checkout@v2
      - run : mkdir tmp -m 777
      - run: cp config/database.example.yml config/database.yml
      - run: cp config/application.example.yml config/application.yml
      - run: mysql -h 127.0.0.1 --port 8888 -u root -ppassword -e 'CREATE DATABASE IF NOT EXISTS test;'
#       - name: starting MYSQL 
#         run: sudo systemctl start mysql  
#       - name: creating test database
#         run: |
#             sudo mysql "SET PASSWORD FOR 'root'@'localhost' = 'root';"
#             sudo mysql -e "CREATE DATABASE test DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;"
      
      - uses: ruby/setup-ruby@v1
        with:
           ruby-version: 2.7.1
           
      - name: Setup Node
        uses: actions/setup-node@v1
               
      - run: 'export PATH=$PATH:`yarn global bin`'
      
      - run: export DB=test
      
      - run: export SENDER_EMAIL_ADDRESS='sender@wikiedu.org'
      
      - name: Database and Build
        run: |
            yarn install
            gem install bundler
            gem install rubocop
            gem install rubocop-rspec-focused
            bundle config set path 'vendor'
            bundle install --jobs=3 --retry=3
            
     
        
#       - name: creating test database
#         run: sudo mysql -uroot -proot -e "CREATE DATABASE test DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;"      
      - run: bundle exec rake db:migrate RAILS_ENV=test
      - run: yarn
      - run:  yarn build
      - run:  bundle exec rubocop
      - run:  yarn lint-non-build
            
              
      
