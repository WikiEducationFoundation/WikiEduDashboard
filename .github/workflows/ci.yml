name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest 
  
#     services:
#        mariadb:
#         image: mariadb:10.5
#         env:
#           mysql root password: wikiedu
#           mysql database: dashboard_testing
#           mysql user: wiki
#           mysql password: wikiedu
#           host port: 3306

    steps:
      - uses: actions/checkout@v2

      
#       - name: Installing system dependencies
#         run: sudo apt-get install -y redis-server mariadb-server libmariadb-dev nodejs npm pandoc
      
#       - run: sudo systemctl start mysql
      
#       - run: sudo service mysql stop
#       - name: Set up MariaDB
#         uses: getong/mariadb-action@v1.1
#         with:
#          mysql root password: wikiedu
#          mysql user: wiki
#          mysql password: wikiedu
#          mysql database: dashboard_testing
#          host port: 3306  sudo mysql -e 'CREATE DATABASE test;'
      - run : mkdir tmp -m 777
      - run: cp config/database.example.yml config/database.yml
      - run: cp config/application.example.yml config/application.yml
             
      - name: running datatbase
 
      - run: sudo mysql -u wiki -pwikiedu < test.sql
             
#       - run: sudo mysql -u wiki -pwikiedu -e "CREATE DATABASE test DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;"
    
             
      - uses: ruby/setup-ruby@v1
        with:
           ruby-version: 2.7.1
           
      - name: Setup Node
        uses: actions/setup-node@v1
               
      - run: 'export PATH=$PATH:`yarn global bin`'
      
      - run: export DB=test
      
      - run: export SENDER_EMAIL_ADDRESS='sender@wikiedu.org'
      
      - name: Database and Build
        run: |
            mkdir tmp -m 777
            yarn install
            gem install bundler
            gem install rubocop
            gem install rubocop-rspec-focused
            bundle config set path 'vendor'
            bundle install --jobs=3 --retry=3
            bundle exec rubocop
            
      
      
      

      - name: Running test
        run: |
              bundle install
              yarn
              yarn build
              bundle exec rake db:migrate RAILS_ENV=test
             
