- content_for :before_title, t("#{@presenter.course_string_prefix}.campaign_courses", title: @campaign.title) + ' — '

#react_root{data: {slug: @campaign.slug}}

.container
  - content_for :before_title, t("#{@presenter.course_string_prefix}.campaign_courses", title: @campaign.title) + ' — '

#react_root{data: {slug: @campaign.slug}}

.container
  %section#courses
    .section-header
      %h3
        = t("#{@presenter.course_string_prefix}.campaign_courses", title: @campaign.title)
      = form_tag programs_campaign_path(@campaign.slug, anchor: 'courses_table'), method: :get, accept_charset: 'UTF-8', id: 'campaign_search_form', onsubmit: 'this.action = this.action.replace(/#.*$/, "") + "#courses_table";' do
        .form-fields
          .form-row
            = text_field_tag :title_query, params[:title_query], placeholder: t('form_search.search') + ' ' + t('courses_generic.course'), id: 'title_query', class: 'w100'
          .form-row
            %button.button.border.small.advanced-search-button{type: 'button', onclick: 'var el=document.getElementById("advanced_search_fields"); var expanded=this.getAttribute("aria-expanded")==="true"; this.setAttribute("aria-expanded", (!expanded).toString()); el.style.display = expanded ? "none" : "block";'}= t('form_search.advanced_search')
          .advanced-search.advanced-search-container#advanced_search_fields
            .form-row.relative.advanced-search-grid-large
              %label{for: 'school_select'}= t('courses.school')
              .school-select-wrapper.grid-span-3
                = select_tag 'school[]', options_for_select(@presenter.school_options, params[:school]), multiple: true, id: 'school_select'
                :javascript
                  document.addEventListener('DOMContentLoaded', () => {
                    if (typeof TomSelect !== 'undefined') {
                      new TomSelect('#school_select', {
                        plugins: ['remove_button'],
                        placeholder: 'Select schools...',
                        allowEmptyOption: true
                      });
                    }
                  });
            .form-row.advanced-search-grid-small
              %label{for: 'creation_date_range'}= t("courses.creation_date")
              = text_field_tag :creation_date_range, nil, id: 'creation_date_range', class: 'w100', placeholder: t('courses.creation_date')
              = hidden_field_tag :creation_start, params[:creation_start], id: 'creation_start'
              = hidden_field_tag :creation_end, params[:creation_end], id: 'creation_end'
            .form-row.advanced-search-grid-small
              %label{for: 'start_date_range'}= t("courses.start_date")
              = text_field_tag :start_date_range, nil, id: 'start_date_range', class: 'w100', placeholder: t('courses.start_date')
              = hidden_field_tag :start_date_start, params[:start_date_start], id: 'start_date_start'
              = hidden_field_tag :start_date_end, params[:start_date_end], id: 'start_date_end'
            :javascript
              document.addEventListener('DOMContentLoaded', () => {
                const isLatin = ['es', 'pt'].some(l => locale.startsWith(l));
                const currentLocale = locale.split('-')[0];
                const dateFormat = isLatin ? 'd/m/Y' : 'm/d/Y';

                const setupRangePicker = (rangeSelector, startSelector, endSelector) => {
                  const startInput = document.querySelector(startSelector);
                  const endInput = document.querySelector(endSelector);
                  const startVal = startInput.value;
                  const endVal = endInput.value;
                  const defaultDate = (startVal && endVal) ? [startVal, endVal] : null;

                  flatpickr(rangeSelector, {
                    mode: 'range',
                    altInput: true,
                    altFormat: dateFormat,
                    dateFormat: 'Y-m-d',
                    defaultDate: defaultDate,
                    locale: isLatin ? currentLocale : 'default',
                    allowInput: true,
                    onClose: function(selectedDates, dateStr, instance) {
                      if (selectedDates.length === 2) {
                        startInput.value = instance.formatDate(selectedDates[0], 'Y-m-d');
                        endInput.value = instance.formatDate(selectedDates[1], 'Y-m-d');
                      } else {
                        startInput.value = '';
                        endInput.value = '';
                      }
                    }
                  });
                };

                setupRangePicker('#creation_date_range', '#creation_start', '#creation_end');
                setupRangePicker('#start_date_range', '#start_date_start', '#start_date_end');
              });
            .form-row.advanced-search-grid-small
              %label{for: 'revisions_min'}= t("metrics.revisions")
              .input-group.flex-input-group
                = number_field_tag :revisions_min, params[:revisions_min], id: 'revisions_min', min: 0, class: 'w100', placeholder: 'Min'
                %span -
                = number_field_tag :revisions_max, params[:revisions_max], id: 'revisions_max', min: 0, class: 'w100', placeholder: 'Max'
            .form-row.advanced-search-grid-small
              %label{for: 'word_count_min'}= t("metrics.word_count")
              .input-group.flex-input-group
                = number_field_tag :word_count_min, params[:word_count_min], id: 'word_count_min', min: 0, class: 'w100', placeholder: 'Min'
                %span -
                = number_field_tag :word_count_max, params[:word_count_max], id: 'word_count_max', min: 0, class: 'w100', placeholder: 'Max'
            .form-row.advanced-search-grid-small
              %label{for: 'references_min'}= t("metrics.references_count")
              .input-group.flex-input-group
                = number_field_tag :references_min, params[:references_min], id: 'references_min', min: 0, class: 'w100', placeholder: 'Min'
                %span -
                = number_field_tag :references_max, params[:references_max], id: 'references_max', min: 0, class: 'w100', placeholder: 'Max'
            .form-row.advanced-search-grid-small
              %label{for: 'views_min'}= t("metrics.view")
              .input-group.flex-input-group
                = number_field_tag :views_min, params[:views_min], id: 'views_min', min: 0, class: 'w100', placeholder: 'Min'
                %span -
                = number_field_tag :views_max, params[:views_max], id: 'views_max', min: 0, class: 'w100', placeholder: 'Max'
            .form-row.advanced-search-grid-small
              %label{for: 'users_min'}= t("users.editors")
              .input-group.flex-input-group
                = number_field_tag :users_min, params[:users_min], id: 'users_min', min: 0, class: 'w100', placeholder: 'Min'
                %span -
                = number_field_tag :users_max, params[:users_max], id: 'users_max', min: 0, class: 'w100', placeholder: 'Max'
        .form-actions
          %button.button{type: 'submit'}= t('campaign.search')
          %button.button.button--clear{type: 'button', onclick: 'document.getElementById("title_query").value=""; document.getElementById("creation_start").value=""; document.getElementById("creation_end").value=""; document.getElementById("start_date_start").value=""; document.getElementById("start_date_end").value=""; document.getElementById("school_select").value=""; document.getElementById("revisions_min").value=""; document.getElementById("revisions_max").value=""; document.getElementById("word_count_min").value=""; document.getElementById("word_count_max").value=""; document.getElementById("references_min").value=""; document.getElementById("references_max").value=""; document.getElementById("views_min").value=""; document.getElementById("views_max").value=""; document.getElementById("users_min").value=""; document.getElementById("users_max").value=""; this.form.action = this.form.action.replace(/#.*$/, "") + "#courses_table"; this.form.submit();'}= t('form_search.clear')
      .sort-select
        %select.sorts{rel: 'courses'}
          %option{rel: 'asc', value: 'title'}
            = t("courses.title")
          %option{rel: 'asc', value: 'school'}
            = t("courses.school")
          %option{rel: 'desc', value: 'revisions'}
            = t("metrics.revisions")
          %option{rel: 'desc', value: 'characters'}
            = t("metrics.word_count")
          %option{rel: 'desc', value: 'average-words'}
            = t("metrics.word_count_average")
          %option{rel: 'desc', value: 'references'}
            = t("metrics.references_count")
          %option{rel: 'desc', value: 'views'}
            = t("metrics.view")
          %option{rel: 'desc', value: 'students'}
            = t("users.editors")
          %option{rel: 'desc', value: 'untrained'}
            = t("courses.untrained")
          - unless Features.wiki_ed?
            %option{rel: 'desc', value: 'creation-date'}
              = t("courses.creation_date")
          %option{rel: 'asc', value: 'start-date'}
            = t("courses.start_date")

    %table.table.table--hoverable.table--sortable{ id: 'courses_table' }
      %thead
        %tr
          %th.sort.sortable{'data-default-order' => 'asc', 'data-sort' => 'title'}
            = t("#{@presenter.course_string_prefix}.courses")
            %span.sortable-indicator
          %th.sort.sortable{style: 'width: 200px;', 'data-default-order' => 'asc', 'data-sort' => 'school'}
            = t("#{@presenter.course_string_prefix}.school_and_term")
            %span.sortable-indicator
          - if Features.wiki_ed?
            %th Instructor
          %th.sort.sortable.desc{style: 'width: 165px;', 'data-default-order' => 'desc', 'data-sort' => 'revisions'}
            .tooltip-trigger
              = t('metrics.revisions')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= t('courses.revisions_doc', timeframe: RevisionStatTimeslice::REVISION_WINDOW_DAYS)
          %th.sort.sortable{style: 'width: 172px;', 'data-default-order' => 'desc', 'data-sort' => 'characters'}
            .tooltip-trigger
              = t('metrics.word_count')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= course_i18n('word_count_doc')
          %th.sort.sortable{style: 'width: 172px;', 'data-default-order' => 'desc', 'data-sort' => 'references'}
            .tooltip-trigger
              = t('metrics.references_count')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= t('metrics.references_doc')
          %th.sort.sortable{style: 'width: 125px;', 'data-default-order' => 'desc', 'data-sort' => 'views'}
            .tooltip-trigger
              = t('metrics.view')
              %span.sortable-indicator
              %span.tooltip-indicator
              .tooltip.dark
                %p= t('courses.view_doc')
          %th.sort.sortable{style: 'width: 200px;', 'data-default-order' => 'desc', 'data-sort' => 'students'}
            = t('users.editors')
            %span.sortable-indicator
          - unless Features.wiki_ed?
            %th.sort.sortable{'data-default-order' => 'desc', 'data-sort' => 'creation-date', style: 'width: 160px'}
              = t('courses.creation_date')
              %span.sortable-indicator

          %th.sort.sortable{style: 'width: 160px;', 'data-default-order' => 'desc', 'data-sort' => 'start-date'}
            = t('courses.start_date')
            %span.sortable-indicator

          - if @presenter.can_remove_course?
            %th{style: 'width:100px'}
              = t('courses.actions')
      %tbody.list
        - if @search_terms.present?
          - if @results.count > 1
            %h4= t('application.search_results.other', search_terms: @search_terms, count: @results.count)
          -else
            %h4= t('application.search_results.one', search_terms: @search_terms, count: @results.count)
          - @results.each do |c|
            = render 'campaigns/course_row', course: c, admin: false, user: false
        - else
          - programs = @presenter.courses_by_recent_edits
          = will_paginate programs
          - programs.each do |course|
            - cache [course, locale, @presenter.can_remove_course?]  do
              = render 'campaigns/course_row', course: course, admin: false, user: false
