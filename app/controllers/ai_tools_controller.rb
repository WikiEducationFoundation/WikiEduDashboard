# frozen_string_literal: true

require_dependency "#{Rails.root}/lib/pangram_api"
require_dependency "#{Rails.root}/lib/utils/wiki_url_parser"

class AiToolsController < ApplicationController
  before_action :require_admin_permissions

  def show; end

  def compare_pangrams
    parse_url
    @diff_mode = params[:diff_mode] == 'true'
    @plain = GetRevisionPlaintext.new(@rev_id, @wiki, diff_mode: @diff_mode, from_rev: @from_rev)
    @pangram_v2_result = PangramApi.v2.inference @plain.plain_text
    @pangram_v3_result = PangramApi.v3.inference @plain.plain_text
    # @pangram_v2_result = {"text"=>"all a high-quality film article.", "avg_ai_likelihood"=>1.0, "max_ai_likelihood"=>1.0, "prediction"=>"Fully AI-Generated", "prediction_short"=>"AI", "headline"=>"AI Detected", "windows"=>[{"text"=>"Which article are you evaluating?\n\n\nTerminator 2: Judgment Day\n\n\n\nWhy you have chosen this article to evaluate?\n\n\nI chose this article primarily because we've spent a lot of time in this class talking about humanoid robots and robots in human spaces. The photo of Arnold Schwarzenegger as the Terminator has come up multiple times in presentations so this movie felt very relevant to our purposes. Moreover, Terminator 2 is arguable one of the best made sequels ever -- so it has a significance cultural impact. Evaluating such a high profile articles helps me assess how well Wikipedia handles a subject with abundant information, sources, and public interest. This will be helpful for me to complete the Wikipedia assignment in the upcoming weeks. \n\n\nEvaluate the article\n\n\nLead Section:\n\n\n+ clearly introduces the film (title, year, director, stars, genre).\n+ summarizes plot, production, and cultural impact.\n- overly detailed (budget, rights dispute) -- could be moved to body.\n- strong overview but would benefit from more concision.\n\nContent:\n\n\n+ covers all key areas -- plot, cast, production, release, reception, legacy.\n+ up-to-date (includes 2023 National Film Registry).\n- plot section is too long, may benefit from more succinct writing.\n- some casting/production anecdotes read like trivia.\noverall comprehensive but slightly bloated.\n\nTone and Balance:\n\n\n+ neutral overall; evaluative claims are attributed to sources.\n+ balanced coverage of praise and criticism.\n- some language in \"Legacy\" section leans toward admiration.\n+ no overrepresentation of fringe views.\n\nSources and References:\n\n\n+ heavily cited with reliable sources (news, books, interviews).\n- relies heavily on entertainment journalism; needs more academic film studies.\n- mix of contemporary and historical sources; could add recent scholarship.\n+ links appear functional.\n\nOrganization and Writing Quality:\n\n\n+ follows standard film article structure.\n+ clear, professional writing with no major errors.\n- length is the main issue -- Plot and Lead sections are too long.\n+ logical flow overall.\n\nImages and Media:\n\n\n+ includes poster, cast photos, and production stills.\n- captions seem accurate but sometimes banal.\n+ fair use is followed.\n- could add more iconic stills for context.\n\nTalk Page Discussion:\n\n\n+ covers minor corrections and factual clarifications.\n+ mostly fine-tuning, no major disputes; overall collaborative.", "ai_likelihood"=>1.0, "label"=>"AI", "confidence"=>"High", "start_index"=>0, "end_index"=>2412, "word_count"=>366, "token_length"=>495}, {"text"=>"\n\nOverall Impressions:\n\n\nStrengths -- comprehensive, well-structured, neutral, Featured Article quality,\nImprovements -- somewhat over-detailed and leans on popular sources.\nfully developed and all in all a high-quality film article.", "ai_likelihood"=>1.0, "label"=>"AI", "confidence"=>"High", "start_index"=>2412, "end_index"=>2645, "word_count"=>29, "token_length"=>47}], "window_likelihoods"=>[1.0, 1.0], "window_indices"=>[[0, 2412], [2412, 2645]], "fraction_human"=>0.0, "fraction_ai"=>1.0, "fraction_mixed"=>0.0, "metadata"=>{}, "version"=>"adaptive_boundaries", "dashboard_link"=>"https://www.pangram.com/history/475303c6-9a12-47f5-8803-33f7e10e266c"}
    # @pangram_v3_result = {"text"=>"Which article are you evaluating?\n\n\nTerminator 2: Judgment Day\n\n\n\nWhy you have chosen this article to evaluate?\n\n\nI chose this article primarily because we've spent a lot of time in this class talking about humanoid robots and robots in human spaces. The photo of Arnold Schwarzenegger as the Terminator has come up multiple times in presentations so this movie felt very relevant to our purposes. Moreover, Terminator 2 is arguable one of the best made sequels ever -- so it has a significance cultural impact. Evaluating such a high profile articles helps me assess how well Wikipedia handles a subject with abundant information, sources, and public interest. This will be helpful for me to complete the Wikipedia assignment in the upcoming weeks. \n\n\nEvaluate the article\n\n\nLead Section:\n\n\n+ clearly introduces the film (title, year, director, stars, genre).\n+ summarizes plot, production, and cultural impact.\n- overly detailed (budget, rights dispute) -- could be moved to body.\n- strong overview but would benefit from more concision.\n\nContent:\n\n\n+ covers all key areas -- plot, cast, production, release, reception, legacy.\n+ up-to-date (includes 2023 National Film Registry).\n- plot section is too long, may benefit from more succinct writing.\n- some casting/production anecdotes read like trivia.\noverall comprehensive but slightly bloated.\n\nTone and Balance:\n\n\n+ neutral overall; evaluative claims are attributed to sources.\n+ balanced coverage of praise and criticism.\n- some language in \"Legacy\" section leans toward admiration.\n+ no overrepresentation of fringe views.\n\nSources and References:\n\n\n+ heavily cited with reliable sources (news, books, interviews).\n- relies heavily on entertainment journalism; needs more academic film studies.\n- mix of contemporary and historical sources; could add recent scholarship.\n+ links appear functional.\n\nOrganization and Writing Quality:\n\n\n+ follows standard film article structure.\n+ clear, professional writing with no major errors.\n- length is the main issue -- Plot and Lead sections are too long.\n+ logical flow overall.\n\nImages and Media:\n\n\n+ includes poster, cast photos, and production stills.\n- captions seem accurate but sometimes banal.\n+ fair use is followed.\n- could add more iconic stills for context.\n\nTalk Page Discussion:\n\n\n+ covers minor corrections and factual clarifications.\n+ mostly fine-tuning, no major disputes; overall collaborative.\n\nOverall Impressions:\n\n\nStrengths -- comprehensive, well-structured, neutral, Featured Article quality,\nImprovements -- somewhat over-detailed and leans on popular sources.\nfully developed and all in all a high-quality film article.", "version"=>"3.0", "headline"=>"Fully AI Generated", "prediction"=>"We are confident that this document is fully AI-generated", "prediction_short"=>"AI", "fraction_ai"=>1.0, "fraction_ai_assisted"=>0.0, "fraction_human"=>0.0, "num_ai_segments"=>2, "num_ai_assisted_segments"=>0, "num_human_segments"=>0, "windows"=>[{"text"=>"Which article are you evaluating?\n\n\nTerminator 2: Judgment Day\n\n\n\nWhy you have chosen this article to evaluate?\n\n\nI chose this article primarily because we've spent a lot of time in this class talking about humanoid robots and robots in human spaces. The photo of Arnold Schwarzenegger as the Terminator has come up multiple times in presentations so this movie felt very relevant to our purposes. Moreover, Terminator 2 is arguable one of the best made sequels ever -- so it has a significance cultural impact. Evaluating such a high profile articles helps me assess how well Wikipedia handles a subject with abundant information, sources, and public interest. This will be helpful for me to complete the Wikipedia assignment in the upcoming weeks. \n\n\nEvaluate the article\n\n\nLead Section:\n\n\n+ clearly introduces the film (title, year, director, stars, genre).\n+ summarizes plot, production, and cultural impact.\n- overly detailed (budget, rights dispute) -- could be moved to body.\n- strong overview but would benefit from more concision.\n\nContent:\n\n\n+ covers all key areas -- plot, cast, production, release, reception, legacy.\n+ up-to-date (includes 2023 National Film Registry).\n- plot section is too long, may benefit from more succinct writing.\n- some casting/production anecdotes read like trivia.\noverall comprehensive but slightly bloated.\n\nTone and Balance:\n\n\n+ neutral overall; evaluative claims are attributed to sources.\n+ balanced coverage of praise and criticism.\n- some language in \"Legacy\" section leans toward admiration.\n+ no overrepresentation of fringe views.\n\nSources and References:\n\n\n+ heavily cited with reliable sources (news, books, interviews).\n- relies heavily on entertainment journalism; needs more academic film studies.\n- mix of contemporary and historical sources; could add recent scholarship.\n+ links appear functional.\n\nOrganization and Writing Quality:\n\n\n+ follows standard film article structure.\n+ clear, professional writing with no major errors.\n- length is the main issue -- Plot and Lead sections are too long.\n+ logical flow overall.\n\nImages and Media:\n\n\n+ includes poster, cast photos, and production stills.\n- captions seem accurate but sometimes banal.\n+ fair use is followed.\n- could add more iconic stills for context.\n\nTalk Page Discussion:\n\n\n+ covers minor corrections and factual clarifications.\n+ mostly fine-tuning, no major disputes; overall collaborative.", "label"=>"AI-Generated", "ai_assistance_score"=>1.0, "confidence"=>"High", "start_index"=>0, "end_index"=>2412, "word_count"=>366, "token_length"=>495}, {"text"=>"\n\nOverall Impressions:\n\n\nStrengths -- comprehensive, well-structured, neutral, Featured Article quality,\nImprovements -- somewhat over-detailed and leans on popular sources.\nfully developed and all in all a high-quality film article.", "label"=>"AI-Generated", "ai_assistance_score"=>1.0, "confidence"=>"High", "start_index"=>2412, "end_index"=>2645, "word_count"=>29, "token_length"=>47}], "dashboard_link"=>"https://www.pangram.com/history/1b4d2c0d-4116-43f7-9a0a-edc5bbe21cb3"}

    render 'show'
  end

  private

  def parse_url
    @url = params[:article_or_diff_url]
    parser = WikiUrlParser.new(@url)
    @wiki = parser.wiki
    @article_title= parser.title
    revs = [parser.oldid, parser.diff].compact
    @rev_id = revs.max
    @from_rev = revs.min if revs.count == 2
  end
end
